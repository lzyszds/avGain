"use strict";var Me=Object.defineProperty;var ve=(t,e,n)=>e in t?Me(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var F=(t,e,n)=>(ve(t,typeof e!="symbol"?e+"":e,n),n);const p=require("electron"),Le=require("node:os"),P=require("node:path"),Ce=require("events"),h=require("fs"),v=require("path"),ae=require("https"),Fe=require("sudo-prompt"),Y=require("element-plus"),$e=require("worker_threads"),Te=require("child_process"),Ae=require("m3u8-parser");var G=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Be(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var de={},U={exports:{}},re={};Object.defineProperty(re,"__esModule",{value:!0});const Z=(t,e)=>`${t.id}-${e}`;class We{constructor(){this.nextId=0,this.storage={},this.owners={},this.electronIds=new WeakMap}add(e,n,r){const o=this.saveToStorage(r),a=Z(e,n);let l=this.owners[a];return l||(l=this.owners[a]=new Map,this.registerDeleteListener(e,n)),l.has(o)||(l.set(o,0),this.storage[o].count++),l.set(o,l.get(o)+1),o}get(e){const n=this.storage[e];if(n!=null)return n.object}remove(e,n,r){const o=Z(e,n),a=this.owners[o];if(a&&a.has(r)){const l=a.get(r)-1;l<=0?(a.delete(r),this.dereference(r)):a.set(r,l)}}clear(e,n){const r=Z(e,n),o=this.owners[r];if(o){for(const a of o.keys())this.dereference(a);delete this.owners[r]}}saveToStorage(e){let n=this.electronIds.get(e);return n||(n=++this.nextId,this.storage[n]={count:0,object:e},this.electronIds.set(e,n)),n}dereference(e){const n=this.storage[e];n!=null&&(n.count-=1,n.count===0&&(this.electronIds.delete(n.object),delete this.storage[e]))}registerDeleteListener(e,n){const r=n.split("-")[0],o=(a,l)=>{l&&l.toString()===r&&(e.removeListener("render-view-deleted",o),this.clear(e,n))};e.on("render-view-deleted",o)}}re.default=new We;var $={};Object.defineProperty($,"__esModule",{value:!0});$.deserialize=$.serialize=$.isSerializableObject=$.isPromise=void 0;const ze=p;function Ie(t){return t&&t.then&&t.then instanceof Function&&t.constructor&&t.constructor.reject&&t.constructor.reject instanceof Function&&t.constructor.resolve&&t.constructor.resolve instanceof Function}$.isPromise=Ie;const Ve=[Boolean,Number,String,Date,Error,RegExp,ArrayBuffer];function ie(t){return t===null||ArrayBuffer.isView(t)||Ve.some(e=>t instanceof e)}$.isSerializableObject=ie;const fe=function(t,e){const r=Object.entries(t).map(([o,a])=>[o,e(a)]);return Object.fromEntries(r)};function ke(t){const e=[],n=t.getScaleFactors();if(n.length===1){const r=n[0],o=t.getSize(r),a=t.toBitmap({scaleFactor:r});e.push({scaleFactor:r,size:o,buffer:a})}else for(const r of n){const o=t.getSize(r),a=t.toDataURL({scaleFactor:r});e.push({scaleFactor:r,size:o,dataURL:a})}return{__ELECTRON_SERIALIZED_NativeImage__:!0,representations:e}}function Ne(t){const e=ze.nativeImage.createEmpty();if(t.representations.length===1){const{buffer:n,size:r,scaleFactor:o}=t.representations[0],{width:a,height:l}=r;e.addRepresentation({buffer:n,scaleFactor:o,width:a,height:l})}else for(const n of t.representations){const{dataURL:r,size:o,scaleFactor:a}=n,{width:l,height:g}=o;e.addRepresentation({dataURL:r,scaleFactor:a,width:l,height:g})}return e}function X(t){return t&&t.constructor&&t.constructor.name==="NativeImage"?ke(t):Array.isArray(t)?t.map(X):ie(t)?t:t instanceof Object?fe(t,X):t}$.serialize=X;function Q(t){return t&&t.__ELECTRON_SERIALIZED_NativeImage__?Ne(t):Array.isArray(t)?t.map(Q):ie(t)?t:t instanceof Object?fe(t,Q):t}$.deserialize=Q;var J={};Object.defineProperty(J,"__esModule",{value:!0});J.getElectronBinding=void 0;const xe=t=>process._linkedBinding?process._linkedBinding("electron_common_"+t):process.electronBinding?process.electronBinding(t):null;J.getElectronBinding=xe;U.exports;(function(t,e){var n=G&&G.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(e,"__esModule",{value:!0}),e.initialize=e.isInitialized=e.enable=e.isRemoteModuleEnabled=void 0;const r=Ce,o=n(re),a=$,l=p,g=J,{Promise:m}=G,y=g.getElectronBinding("v8_util"),O=(()=>{var i,u;const s=Number((u=(i=process.versions.electron)===null||i===void 0?void 0:i.split("."))===null||u===void 0?void 0:u[0]);return Number.isNaN(s)||s<14})(),b=["length","name","arguments","caller","prototype"],w=new Map,E=new FinalizationRegistry(i=>{const u=i.id[0]+"~"+i.id[1],s=w.get(u);if(s!==void 0&&s.deref()===void 0&&(w.delete(u),!i.webContents.isDestroyed()))try{i.webContents.sendToFrame(i.frameId,"REMOTE_RENDERER_RELEASE_CALLBACK",i.id[0],i.id[1])}catch(d){console.warn(`sendToFrame() failed: ${d}`)}});function _(i){const u=i[0]+"~"+i[1],s=w.get(u);if(s!==void 0){const d=s.deref();if(d!==void 0)return d}}function T(i,u,s,d){const c=new WeakRef(d),f=i[0]+"~"+i[1];return w.set(f,c),E.register(d,{id:i,webContents:u,frameId:s}),d}const L=new WeakMap,A=function(i){let u=Object.getOwnPropertyNames(i);return typeof i=="function"&&(u=u.filter(s=>!b.includes(s))),u.map(s=>{const d=Object.getOwnPropertyDescriptor(i,s);let c,f=!1;return d.get===void 0&&typeof i[s]=="function"?c="method":((d.set||d.writable)&&(f=!0),c="get"),{name:s,enumerable:d.enumerable,writable:f,type:c}})},C=function(i){const u=Object.getPrototypeOf(i);return u===null||u===Object.prototype?null:{members:A(u),proto:C(u)}},S=function(i,u,s,d=!1){let c;switch(typeof s){case"object":s instanceof Buffer?c="buffer":s&&s.constructor&&s.constructor.name==="NativeImage"?c="nativeimage":Array.isArray(s)?c="array":s instanceof Error?c="error":a.isSerializableObject(s)?c="value":a.isPromise(s)?c="promise":Object.prototype.hasOwnProperty.call(s,"callee")&&s.length!=null?c="array":d&&y.getHiddenValue(s,"simple")?c="value":c="object";break;case"function":c="function";break;default:c="value";break}return c==="array"?{type:c,members:s.map(f=>S(i,u,f,d))}:c==="nativeimage"?{type:c,value:a.serialize(s)}:c==="object"||c==="function"?{type:c,name:s.constructor?s.constructor.name:"",id:o.default.add(i,u,s),members:A(s),proto:C(s)}:c==="buffer"?{type:c,value:s}:c==="promise"?(s.then(function(){},function(){}),{type:c,then:S(i,u,function(f,R){s.then(f,R)})}):c==="error"?{type:c,value:s,members:Object.keys(s).map(f=>({name:f,value:S(i,u,s[f])}))}:{type:"value",value:s}},M=function(i){const u=new Error(i);throw u.code="EBADRPC",u.errno=-72,u},oe=(i,u)=>{let d=`Attempting to call a function in a renderer window that has been closed or released.
Function provided here: ${L.get(u)}`;if(i instanceof r.EventEmitter){const c=i.eventNames().filter(f=>i.listeners(f).includes(u));c.length>0&&(d+=`
Remote event names: ${c.join(", ")}`,c.forEach(f=>{i.removeListener(f,u)}))}console.warn(d)},Ee=(i,u)=>new Proxy(Object,{get(s,d,c){return d==="name"?u:Reflect.get(s,d,c)}}),V=function(i,u,s,d){const c=function(f){switch(f.type){case"nativeimage":return a.deserialize(f.value);case"value":return f.value;case"remote-object":return o.default.get(f.id);case"array":return V(i,u,s,f.value);case"buffer":return Buffer.from(f.value.buffer,f.value.byteOffset,f.value.byteLength);case"promise":return m.resolve({then:c(f.then)});case"object":{const R=f.name!=="Object"?Object.create({constructor:Ee(Object,f.name)}):{};for(const{name:W,value:z}of f.members)R[W]=c(z);return R}case"function-with-return-value":{const R=c(f.value);return function(){return R}}case"function":{const R=[s,f.id],W=_(R);if(W!==void 0)return W;const z=function(...je){let se=!1;if(!i.isDestroyed())try{se=i.sendToFrame(u,"REMOTE_RENDERER_CALLBACK",s,f.id,S(i,s,je))!==!1}catch(De){console.warn(`sendToFrame() failed: ${De}`)}se||oe(this,z)};return L.set(z,f.location),Object.defineProperty(z,"length",{value:f.length}),T(R,i,u,z),z}default:throw new TypeError(`Unknown type: ${f.type}`)}};return d.map(c)},Se=function(i){const u=i.getLastWebPreferences()||{};return u.enableRemoteModule!=null?!!u.enableRemoteModule:!1},H=new WeakMap,Pe=function(i){return O&&!H.has(i)&&H.set(i,Se(i)),H.get(i)};e.isRemoteModuleEnabled=Pe;function Re(i){H.set(i,!0)}e.enable=Re;const D=function(i,u){l.ipcMain.on(i,(s,d,...c)=>{let f;if(!e.isRemoteModuleEnabled(s.sender)){s.returnValue={type:"exception",value:S(s.sender,d,new Error('@electron/remote is disabled for this WebContents. Call require("@electron/remote/main").enable(webContents) to enable it.'))};return}try{f=u(s,d,...c)}catch(R){f={type:"exception",value:S(s.sender,d,R)}}f!==void 0&&(s.returnValue=f)})},N=function(i,u,...s){const d={sender:i,returnValue:void 0,defaultPrevented:!1};return l.app.emit(u,d,i,...s),i.emit(u,d,...s),d},x=function(i,u,s){s&&console.warn(`WebContents (${i.id}): ${u}`,s)};let K=!1;function Oe(){return K}e.isInitialized=Oe;function _e(){if(K)throw new Error("@electron/remote has already been initialized");K=!0,D("REMOTE_BROWSER_WRONG_CONTEXT_ERROR",function(i,u,s,d){const f=_([s,d]);f!==void 0&&oe(i.sender,f)}),D("REMOTE_BROWSER_REQUIRE",function(i,u,s,d){x(i.sender,`remote.require('${s}')`,d);const c=N(i.sender,"remote-require",s);if(c.returnValue===void 0){if(c.defaultPrevented)throw new Error(`Blocked remote.require('${s}')`);if(process.mainModule)c.returnValue=process.mainModule.require(s);else{let f=t;for(;f.parent;)f=f.parent;c.returnValue=f.require(s)}}return S(i.sender,u,c.returnValue)}),D("REMOTE_BROWSER_GET_BUILTIN",function(i,u,s,d){x(i.sender,`remote.getBuiltin('${s}')`,d);const c=N(i.sender,"remote-get-builtin",s);if(c.returnValue===void 0){if(c.defaultPrevented)throw new Error(`Blocked remote.getBuiltin('${s}')`);c.returnValue=p[s]}return S(i.sender,u,c.returnValue)}),D("REMOTE_BROWSER_GET_GLOBAL",function(i,u,s,d){x(i.sender,`remote.getGlobal('${s}')`,d);const c=N(i.sender,"remote-get-global",s);if(c.returnValue===void 0){if(c.defaultPrevented)throw new Error(`Blocked remote.getGlobal('${s}')`);c.returnValue=G[s]}return S(i.sender,u,c.returnValue)}),D("REMOTE_BROWSER_GET_CURRENT_WINDOW",function(i,u,s){x(i.sender,"remote.getCurrentWindow()",s);const d=N(i.sender,"remote-get-current-window");if(d.returnValue===void 0){if(d.defaultPrevented)throw new Error("Blocked remote.getCurrentWindow()");d.returnValue=i.sender.getOwnerBrowserWindow()}return S(i.sender,u,d.returnValue)}),D("REMOTE_BROWSER_GET_CURRENT_WEB_CONTENTS",function(i,u,s){x(i.sender,"remote.getCurrentWebContents()",s);const d=N(i.sender,"remote-get-current-web-contents");if(d.returnValue===void 0){if(d.defaultPrevented)throw new Error("Blocked remote.getCurrentWebContents()");d.returnValue=i.sender}return S(i.sender,u,d.returnValue)}),D("REMOTE_BROWSER_CONSTRUCTOR",function(i,u,s,d){d=V(i.sender,i.frameId,u,d);const c=o.default.get(s);return c==null&&M(`Cannot call constructor on missing remote object ${s}`),S(i.sender,u,new c(...d))}),D("REMOTE_BROWSER_FUNCTION_CALL",function(i,u,s,d){d=V(i.sender,i.frameId,u,d);const c=o.default.get(s);c==null&&M(`Cannot call function on missing remote object ${s}`);try{return S(i.sender,u,c(...d),!0)}catch(f){const R=new Error(`Could not call remote function '${c.name||"anonymous"}'. Check that the function signature is correct. Underlying error: ${f}
`+(f instanceof Error?`Underlying stack: ${f.stack}
`:""));throw R.cause=f,R}}),D("REMOTE_BROWSER_MEMBER_CONSTRUCTOR",function(i,u,s,d,c){c=V(i.sender,i.frameId,u,c);const f=o.default.get(s);return f==null&&M(`Cannot call constructor '${d}' on missing remote object ${s}`),S(i.sender,u,new f[d](...c))}),D("REMOTE_BROWSER_MEMBER_CALL",function(i,u,s,d,c){c=V(i.sender,i.frameId,u,c);const f=o.default.get(s);f==null&&M(`Cannot call method '${d}' on missing remote object ${s}`);try{return S(i.sender,u,f[d](...c),!0)}catch(R){const W=new Error(`Could not call remote method '${d}'. Check that the method signature is correct. Underlying error: ${R}`+(R instanceof Error?`Underlying stack: ${R.stack}
`:""));throw W.cause=R,W}}),D("REMOTE_BROWSER_MEMBER_SET",function(i,u,s,d,c){c=V(i.sender,i.frameId,u,c);const f=o.default.get(s);return f==null&&M(`Cannot set property '${d}' on missing remote object ${s}`),f[d]=c[0],null}),D("REMOTE_BROWSER_MEMBER_GET",function(i,u,s,d){const c=o.default.get(s);return c==null&&M(`Cannot get property '${d}' on missing remote object ${s}`),S(i.sender,u,c[d])}),D("REMOTE_BROWSER_DEREFERENCE",function(i,u,s){o.default.remove(i.sender,u,s)}),D("REMOTE_BROWSER_CONTEXT_RELEASE",(i,u)=>(o.default.clear(i.sender,u),null))}e.initialize=_e})(U,U.exports);var He=U.exports;(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.enable=t.isInitialized=t.initialize=void 0;var e=He;Object.defineProperty(t,"initialize",{enumerable:!0,get:function(){return e.initialize}}),Object.defineProperty(t,"isInitialized",{enumerable:!0,get:function(){return e.isInitialized}}),Object.defineProperty(t,"enable",{enumerable:!0,get:function(){return e.enable}})})(de);var Ge=de;const he=Be(Ge);function ee(t){return h.existsSync(t)?!1:h.existsSync(P.dirname(t))?(h.mkdirSync(t),!0):(h.mkdirSync(P.dirname(t)),!1)}const te=t=>{const e=P.join(t.getPath("documents"),"javPlayer");return ee(e),h.existsSync(P.join(e,"data"))||ee(P.join(e,"data")),h.existsSync(P.join(e,"storeLog.json"))||h.writeFileSync(P.join(e,"storeLog.json"),`{
      "coverPath": "",
      "previewPath": "",
      "videoPath": "",
      "downloadPath": "",
      "starArr": []
    }`,"utf-8"),e},qe=(t,e)=>{const n=P.join(t.getPath("documents"),"javPlayer"),r=P.join(n,"storeLog.json");let o=JSON.stringify(e);if(h.existsSync(r)){let a=h.readFileSync(r,"utf-8"),l=JSON.parse(a);o=JSON.stringify({...l,...e})}h.writeFileSync(r,o,"utf-8")},Ue=t=>{const e=P.join(t.getPath("documents"),"javPlayer"),n=P.join(e,"storeLog.json");if(h.existsSync(n)){let r=h.readFileSync(n,"utf-8");return JSON.parse(r)}return{}};function pe(t){let e=0;return h.readdirSync(t).forEach(r=>{const o=P.join(t,r),a=h.statSync(o);a.isFile()?e+=a.size:a.isDirectory()&&(e+=pe(o))}),e}const Je={checkFileNotFoundError(t){return(typeof t=="string"?t:t.message).includes("no such file or directory")},checkPermissionDeniedError(t){return(typeof t=="string"?t:t.message).includes("permission denied")}};function ce(t){const e=["B","KB","MB","GB","TB"];let n=0;for(;t>=1024&&n<e.length-1;)t/=1024,n++;return t.toFixed(2)+e[n]}function k(t,e,n=!0){if(t.length<=1)return t;const r=t[Math.floor(t.length/2)],o=[],a=[],l=[];for(const g of t){if(!g)break;g[e]<r[e]?o.push(g):g[e]>r[e]?l.push(g):a.push(g)}return n?[...k(o,e,n),...a,...k(l,e,n)]:[...k(l,e,n),...a,...k(o,e,n)]}const{exec:ge}=require("child_process");async function Ke(t,e,n,r){const o=n+"\\data",a=h.readdirSync(o),l=[];return a.forEach(async g=>{l.push(t.includes(g))}),new Promise(async(g,m)=>{await ge("aria2c --help",async(y,O,b)=>{if(y||b)if((await p.dialog.showMessageBox({type:"info",title:"提示",message:"aria2c不存在，请安装aria2c并配置环境变量",buttons:["前往下载","已安装进行环境配置"],cancelId:0,defaultId:0})).response===0)p.shell.openExternal("https://github.com/aria2/aria2/releases/");else{const E=await p.dialog.showOpenDialog({title:"选择aria2c安装路径",properties:["openDirectory"]});if(!E.canceled){const _=E.filePaths;Fe.exec(`setx /M PATH "%PATH%;${_}"`,{name:"AvGain"},(T,L,A)=>{A&&p.dialog.showErrorBox("错误",A+""),p.dialog.showMessageBox({type:"info",title:"提示",message:"环境变量配置成功，请重启软件",buttons:["确定"],cancelId:0,defaultId:0}).then(C=>{C.response===0&&r.relaunch()})})}}}),l.includes(!0)||await Ye(t,e,o),h.readdir(o,(y,O)=>{if(y)m(y);else{const b=[];O.forEach((_,T)=>{const L=h.statSync(n+"\\data\\"+_);L.isFile()&&b.push({name:_,time:L.birthtimeMs})});const w=k(b,"time",!1)[0],E=h.readFileSync(n+"\\data\\"+w.name,"utf-8");B.set("📋 m3u8文件下载完成，准备开始下载视频 <br/>",n+"\\log.txt"),g(E)}})})}function Ye(t,e,n){return e='--header="Accept: */*" --header="accept-language: zh-CN,zh;q=0.9,en;q=0.8" --header="Referer: https://emturbovid.com/" --header="Referrer-Policy: strict-origin-when-cross-origin"',new Promise((r,o)=>{let a="";/video\.m3u8$/.test(t)&&(a="-o "+t.split("/")[3]+".m3u8"),ge(`aria2c -d ${n} ${a} ${e} ${t}`,(l,g,m)=>{l&&o(l),m&&(p.dialog.showErrorBox("错误",m),o(m)),r(!0)})})}const B={set:(t,e,n=!1)=>{if(h.existsSync(e)||h.writeFileSync(e,t,"utf-8"),n){var r=/(\🟢 合成成功 )(\d+)(%)/;try{var o=h.readFileSync(e,"utf-8"),a=o.split("<br/>");a=a.filter(l=>!r.test(l)),h.writeFileSync(e,a.join("<br/>"),"utf-8")}catch(l){console.log(l)}}return h.appendFileSync(e,t+"<br/>"),t},get:t=>{if(!h.existsSync(t))h.writeFileSync(t,"","utf-8");else return h.readFileSync(t,"utf-8")},clear:t=>{h.writeFileSync(t,"","utf-8")}},Ze="ffmpeg",Xe=v.join(process.env.USERPROFILE,"Documents"),ne=v.join(Xe,"javPlayer","log.txt");async function Qe(t,e,n){let r=h.readdirSync(e).filter(l=>h.existsSync(v.join(e,l)));if(!r.length)return B.set("🔴 没有找到文件 <br/>",ne);r.sort((l,g)=>parseInt(l.split(".")[0])-parseInt(g.split(".")[0]));const o=50,a=[];try{h.writeFileSync(`${e}/input.txt`,"");for(let g=0;g<r.length;g+=o){const m=r.slice(g,g+o),y=`${e}/${t}${g/o}.mp4`,O=["-i",`concat:${m.join("|")}`,"-c","copy",y];await le(O,e),a.push(y),h.appendFileSync(`${e}/input.txt`,`file '${t}${g/o}.mp4'
`);const b=Math.floor(g/r.length*100);B.set(`🟢 合成成功 ${b}% <br/>`,ne,!0)}const l=et(`${n}/${t}.mp4`);return await le(l,e)}catch{return"合成失败"}}function et(t){return["-f","concat","-safe","0","-i","input.txt","-c","copy",t]}function le(t,e){return new Promise((n,r)=>{Te.execFile(Ze,t,{cwd:e,maxBuffer:2048*2048*2048},(o,a,l)=>{o&&(B.set("合成失败"+o,ne),console.log("lzy  error:",o),r("合成失败")),n("合成成功")})})}class tt{constructor(e,n,r){F(this,"win");F(this,"app");F(this,"mainWindow");F(this,"pathJson");F(this,"workerArr");F(this,"docPath");F(this,"setLog");F(this,"taskArray",[]);F(this,"downLoadConfig",{url:"",name:"",designation:""});this.win=e,this.app=n,this.mainWindow=r,this.workerArr=[],this.pathJson={coverPath:"",previewPath:"",videoPath:"",downloadPath:""},this.docPath=v.join(this.app.getPath("documents"),"javPlayer"),this.setLog=o=>B.set(o,this.docPath+"\\log.txt"),this.registerHandleWin(),this.registerHandleOpenDir(),this.registerHandleStoreData(),this.registerGetListData(),this.registerDownloadVideoEvent(),this.registerPauseDownloadEvent(),this.registerGetDownloadListContent(),this.registerDeleteDirFile(),this.registerCreateDir(),this.registerHandleDeleteFile(),this.registeronMergeVideo(),this.registerOpenDir(),this.registerHandleStarVideo(),this.registerGetAllDirPath(),this.registerGetDownloadProgress(),this.registerGetSystemLog(),this.registerClearSystemLog()}handleWinAction(e){return new Promise((n,r)=>{switch(e){case"openDev":this.win.webContents.openDevTools(),n("success");break;case"close":this.closeWindow(),n("success");break;case"minimize":this.minimizeWindow(),n("success");break;case"maximize":this.toggleMaximize(),n("success");break;case"changeTheme":this.toggleTheme(),n("success");break;default:r(new Error("Invalid action"))}})}onHandleWin(e,n){this.handleWinAction(n).then(r=>{e.sender.send("onHandleWin",r)}).catch(r=>{e.sender.send("onHandleWin",{error:r.message})})}registerHandleWin(){p.ipcMain.handle("onHandleWin",this.onHandleWin.bind(this))}closeWindow(){this.win=null,process.platform!=="darwin"&&this.app.quit()}minimizeWindow(){var e;(e=this.win)==null||e.minimize()}toggleMaximize(){var e,n,r;(e=this.win)!=null&&e.isMaximized()?(n=this.win)==null||n.unmaximize():(r=this.win)==null||r.maximize()}toggleTheme(){p.nativeTheme.themeSource=p.nativeTheme.shouldUseDarkColors?"light":"dark"}async onHandleOpenDir(e,n){const r=p.dialog.showOpenDialogSync(this.win,{title:"选择文件夹",properties:["openDirectory"],modal:!0});return r&&r.length>0?r[0]:null}registerHandleOpenDir(){p.ipcMain.handle("onHandleOpenDir",this.onHandleOpenDir.bind(this))}async onHandleStoreData(e,n){let r=n,o;const a=v.join(this.docPath,"storeLog.json"),l=h.readFileSync(a,"utf-8");if(typeof r=="string")return l?JSON.parse(l)[r]:null;if(l){const g=JSON.parse(l);o=Object.assign(g,r)}else te(this.app),o=r;h.writeFileSync(a,JSON.stringify(o),"utf-8")}registerHandleStoreData(){p.ipcMain.handle("onHandleStoreData",this.onHandleStoreData.bind(this))}async onGetListData(e,n){const{coverPath:r,previewPath:o,videoPath:a,starArr:l}=this.onGetAllDirPath(e,"all"),g=this,m=h.readdirSync(a),y=h.readdirSync(r).map(b=>{if(!b.startsWith(".")&&b.indexOf("Thumbs")==0)return null;if(b.indexOf(".png")==-1){const w=b.split(".jpg")[0];m.includes(`${w}.mp4`)&&m.splice(m.indexOf(`${w}.mp4`),1);let E=null,_=null;try{E=h.statSync(`${a}/${w}.mp4`),_={time:Y.dayjs(E.birthtimeMs).format("YYYY-MM-DD HH:mm"),size:ce(E.size)}}catch{E=h.statSync(`${r}/${w}.jpg`),_={time:Y.dayjs(E.birthtimeMs).format("YYYY-MM-DD HH:mm"),size:ce(E.size)}}return{stampTime:E?E.birthtimeMs:null,name:w,cover:`${r}/${w}.jpg`,preview:`${o}/${w}.mp4`,url:`${a}/${w}.mp4`,datails:_,isStar:l.indexOf(w)!=-1}}else return null}).filter(b=>b!==null);m.forEach(b=>{const w=q(b);if(w){const E=b.split(".mp4")[0];g.getPreviewVideo(w,E,0,o,r)}});const O=k(y.filter(b=>b),"stampTime",!1);return O.filter(b=>!b.isStar).concat(O.filter(b=>b.isStar))}registerGetListData(){p.ipcMain.handle("onGetListData",this.onGetListData.bind(this))}onDownloadVideoEvent(e,n){const r=this;return new Promise(async(a,l)=>{const g=v.join(__dirname,"../../electron");let{resource:m,name:y,url:O,thread:b,downPath:w}=n;const E=nt(m),_=q(y);y=ue(y),this.downLoadConfig={url:O,name:y,designation:_},w=w+`/${_}`,ee(w);const{urlPrefix:T,dataArr:L,dataCount:A}=await it.bind(r,E)();if(qe(this.app,{downloadCount:A}),L.length===0)return this.setLog("🔴 无法验证第一个证书 <br/>"),a("无法验证第一个证书");const C=rt(L,b);this.workerArr.forEach(S=>{S.terminate()}),await o();for(let S=0;S<b;S++){const M=new $e.Worker(g+"\\seprate\\worker.js");this.workerArr.push(M),M.postMessage({urlData:C[S],index:S+1,headers:E,urlPrefix:T,downPath:w,docPath:r.docPath})}});async function o(){await Promise.all(r.workerArr.map(a=>new Promise(l=>{a.on("exit",l),a.terminate()}))),r.workerArr=[]}}registerDownloadVideoEvent(){p.ipcMain.handle("downloadVideoEvent",this.onDownloadVideoEvent.bind(this))}onPauseDownloadEvent(e,n){this.workerArr.forEach(r=>{r.terminate()}),this.workerArr=[],this.setLog("🟡 下载任务已暂停<br/>")}registerPauseDownloadEvent(){p.ipcMain.handle("pauseDownloadEvent",this.onPauseDownloadEvent.bind(this))}onGetDownloadListContent(e,n){let r=[];return n&&(r=h.readdirSync(n).map(o=>({state:pe(n+"/"+o),name:o,downloadTime:Y.dayjs(h.statSync(n+"/"+o).birthtimeMs).format("X")}))),r}registerGetDownloadListContent(){p.ipcMain.handle("getDownloadListContent",this.onGetDownloadListContent.bind(this))}onDeleteDirFile(e,n){if(n)try{return h.readdirSync(n).forEach(r=>{h.statSync(n+"/"+r).isDirectory()?h.rmSync(n+"/"+r,{recursive:!0}):h.unlinkSync(n+"/"+r)}),this.setLog("🟡 清空文件夹成功 <br/>")}catch(r){return this.setLog(`🔴 清空文件夹失败 ${r} <br/>`)}}registerDeleteDirFile(){p.ipcMain.handle("deleteDirFile",this.onDeleteDirFile.bind(this))}onCreateDir(e,n){n&&h.mkdirSync(n)}registerCreateDir(){p.ipcMain.handle("onCreateDir",this.onCreateDir.bind(this))}onHandleDeleteFile(e,n){const r=n.split("/")[1].split(".mp4")[0],o=this.setLog,{videoPath:a,previewPath:l,coverPath:g}=this.pathJson;h.access(`${a}/${r}.mp4`,m=>{if(m)return o("🔴 文件不存在 <br/>");try{h.unlinkSync(`${a}/${r}.mp4`)}catch(y){y&&o("🔴 文件占用，等待2分钟后再次删除 <br/>"),setTimeout(()=>{h.unlinkSync(`${a}/${r}.mp4`)},500)}}),h.access(`${l}/${r}.mp4`,m=>{if(m)return o("🔴 文件不存在 <br/>");h.unlinkSync(`${l}/${r}.mp4`)}),h.access(`${g}/${r}.jpg`,m=>{if(m)return o("🔴 文件不存在 <br/>");h.unlinkSync(`${g}/${r}.jpg`)})}registerHandleDeleteFile(){p.ipcMain.handle("onHandleDeleteFile",this.onHandleDeleteFile.bind(this))}async onMergeVideo(e,n){this.setLog("🟢 开始合并视频 <br/> ");let r=0;const{previewPath:o,coverPath:a,downloadPath:l,videoPath:g}=this.pathJson;let{name:m}=n;const y=q(m),O=ue(m);if(!y)return this.setLog("🔴 未找到番号 <br/>");if(h.existsSync(g+"/"+O+".mp4")){this.setLog("🟢 视频已存在 无需进行合并 <br/>");return}const w=await Qe(O,l+`/${y}`,g);return w==="合成成功"?(await this.getPreviewVideo(y,O,r,o,a),h.rm(l+`/${y}`,{recursive:!0},E=>{if(E)return this.setLog(`🔴 分段视频删除失败:${E} <br/>`);this.setLog("🟢 视频合并成功,分段视频已删除 <br/>")}),m):w}registeronMergeVideo(){p.ipcMain.handle("onMergeVideo",this.onMergeVideo.bind(this))}onOpenDir(e,n){const{shell:r}=require("electron");r.showItemInFolder(n)}registerOpenDir(){p.ipcMain.handle("onOpenDir",this.onOpenDir.bind(this))}onHandleStarVideo(e,n){const r=v.join(this.docPath,"storeLog.json"),o=h.readFileSync(r,"utf-8"),a=JSON.parse(o);let l=a.starArr;if(!l)l=[n];else{if(l.indexOf(n)!=-1)return l.splice(l.indexOf(n),1),h.writeFileSync(r,JSON.stringify(Object.assign(a,{starArr:l})),"utf-8");l.push(n)}h.writeFileSync(r,JSON.stringify(Object.assign(a,{starArr:l})),"utf-8")}registerHandleStarVideo(){p.ipcMain.handle("onHandleStarVideo",this.onHandleStarVideo.bind(this))}onGetAllDirPath(e,n){const r=v.join(this.docPath,"storeLog.json"),o=h.readFileSync(r,"utf-8");if(!o)return te(this.app),this.onGetAllDirPath(e,n);const a=JSON.parse(o),{coverPath:l,previewPath:g,videoPath:m,downloadPath:y}=a;return this.pathJson={coverPath:l,previewPath:g,videoPath:m,downloadPath:y},n==="all"?a:this.pathJson}registerGetAllDirPath(){p.ipcMain.handle("onGetAllDirPath",this.onGetAllDirPath.bind(this))}onGetDownloadProgress(e,n){const r=q(n),{downloadPath:o}=this.pathJson,a=Ue(this.app);try{const l=h.readdirSync(o+"/"+r);a.downLoadAfter=l.length}catch(l){Je.checkFileNotFoundError(l)&&(a.downLoadAfter=0)}return a}registerGetDownloadProgress(){p.ipcMain.handle("onGetDownloadProgress",this.onGetDownloadProgress.bind(this))}onGetSystemLog(e,n){const r=v.join(this.docPath,"log.txt");try{return B.get(r)}catch{return"🔴 获取日志失败 <br/>"}}registerGetSystemLog(){p.ipcMain.handle("onGetSystemLog",this.onGetSystemLog.bind(this))}onClearSystemLog(e,n){const r=v.join(this.docPath,"log.txt");try{return B.clear(r),this.setLog("🟡 清空日志成功 <br/>")}catch{return this.setLog("🔴 清空日志失败 <br/>")}}registerClearSystemLog(){p.ipcMain.handle("onClearSystemLog",this.onClearSystemLog.bind(this))}getPreviewVideo(e,n,r,o,a){return new Promise((l,g)=>{const m="https://eightcha.com/",y=this;if(e=e.toLowerCase(),r>=5||0>=5)return;const b=m+`${e}/cover.jpg?class=normal`;ae.get(b,w=>{const E=a+"/"+n+".jpg",_=h.createWriteStream(E);w.pipe(_),_.on("finish",()=>{y.setLog("🟢 封面下载成功 <br/>"),_.close();function T(L){const A=m+`${e}/preview.mp4`;ae.get(A,C=>{const S=o+"/"+n+".mp4",M=h.createWriteStream(S);C.pipe(M),M.on("finish",()=>{y.setLog("🟢 预览视频下载成功 <br/>"),M.close(),l(!0)})}).on("error",C=>{T(),y.setLog(`🔴 (即将重试)下载出错: ${C} <br/>`)})}T()})}).on("error",w=>{this.getPreviewVideo(e,n,++r,o,a),y.setLog(`🔴 (即将重试)下载出错: ${w} <br/>`)})})}}function nt(t){let e={accept:"*/*","accept-language":"zh-CN,zh;q=0.9,en;q=0.8"};return t==="SuperJav"?Object.assign(e,{Referer:"https://emturbovid.com/","Referrer-Policy":"strict-origin-when-cross-origin"}):Object.assign(e,{Referer:"https://missav.com/cn/pppd-985-uncensored-leak",Origin:"https://missav.com"}),e}function q(t){let e=/[a-zA-Z]{2,6}-\d{3,4}/;return t.match(e)?t.split(" ")[0].replace("[无码破解]",""):null}function rt(t,e){const n=Math.ceil(t.length/e),r=[];for(let o=0;o<t.length;o+=n)r.push(t.slice(o,o+n));return r}function ue(t){return t.replace("[无码破解]","").replaceAll(/[^\u4E00-\u9FA5\u3040-\u309F\u30A0-\u30FF\uFF65-\uFF9Fa-zA-Z0-9/-]/g,"").replaceAll(/[\·\・\●\/]/g,"").replaceAll(" ","")}async function it(t){const{url:e,designation:n}=this.downLoadConfig;let r=e.substring(0,e.lastIndexOf("/"))+"/";try{const o=await Ke(e,t,this.docPath,this.app),a=new Ae.Parser;a.push(o),a.end();let l=a.manifest.segments||[];const g=l.length,m=v.join(this.pathJson.downloadPath,n);return h.readdirSync(m).forEach(O=>{l=l.filter(b=>v.basename(b.uri).replace(/[^\d]/g,"")!==O.replace(/[^\d]/g,""))}),{urlPrefix:r,dataArr:l,dataCount:g}}catch(o){return await B.set(`🔴 下载出错: ${o} <br/>`,`${this.docPath}/log.txt`),{urlPrefix:r,dataArr:[],dataCount:0}}}process.env.DIST_ELECTRON=P.join(__dirname,"..");process.env.DIST=P.join(process.env.DIST_ELECTRON,"../dist");process.env.PUBLIC=process.env.VITE_DEV_SERVER_URL?P.join(process.env.DIST_ELECTRON,"../public"):process.env.DIST;global.appRootPath=P.join(__dirname,"../../");Le.release().startsWith("6.1")&&p.app.disableHardwareAcceleration();process.platform==="win32"&&p.app.setAppUserModelId(p.app.getName());p.app.requestSingleInstanceLock()||(p.app.quit(),process.exit(0));p.app.commandLine.appendSwitch("enable-experimental-web-platform-features","true");let j=null,I=null;const me=P.join(__dirname,"../preload/index.js"),we=process.env.VITE_DEV_SERVER_URL,be=P.join(process.env.DIST,"index.html");te(p.app);he.initialize();async function ye(){return j=new p.BrowserWindow({width:1800,height:1e3,minWidth:1260,minHeight:800,title:"avGain",autoHideMenuBar:!0,show:!0,frame:!1,icon:P.join(process.env.PUBLIC,"logo.png"),webPreferences:{devTools:!0,preload:me,webSecurity:!1,nodeIntegration:!1,contextIsolation:!0}}),process.env.VITE_DEV_SERVER_URL?j.loadURL(we):j.loadFile(be),j.webContents.on("did-finish-load",()=>{j==null||j.webContents.send("main-process-message",new Date().toLocaleString())}),j.webContents.setWindowOpenHandler(({url:t})=>(t.startsWith("https:")&&p.shell.openExternal(t),{action:"deny"})),he.enable(j.webContents),j}p.app.whenReady().then(async()=>{ot(),setTimeout(async()=>{const t=await ye();new tt(j,p.app,t),I==null||I.close(),t.webContents.on("did-finish-load",(e,n)=>{t.webContents.setZoomFactor(1),t.webContents.setVisualZoomLevelLimits(1,1)})},2e3)});p.app.on("window-all-closed",()=>{j=null,process.platform!=="darwin"&&p.app.quit()});p.app.on("second-instance",()=>{j&&(j.isMinimized()&&j.restore(),j.focus())});p.app.on("activate",()=>{const t=p.BrowserWindow.getAllWindows();t.length?t[0].focus():ye()});p.ipcMain.handle("open-win",(t,e)=>{const n=new p.BrowserWindow({webPreferences:{preload:me,nodeIntegration:!0,contextIsolation:!1}});process.env.VITE_DEV_SERVER_URL?n.loadURL(`${we}#${e}`):n.loadFile(be,{hash:e})});function ot(){I=new p.BrowserWindow({width:1e3,height:600,frame:!1,skipTaskbar:!1,transparent:!0,resizable:!1,icon:P.join(process.env.PUBLIC,"logo.png"),webPreferences:{experimentalFeatures:!0,preload:process.env.NODE_ENV==="development"?P.join(p.app.getAppPath(),"preload.js"):P.join(p.app.getAppPath(),"dist/electron/main/preload.js")}}),I.loadFile(P.join(global.appRootPath,"/loader.html")),I.on("closed",()=>{I=null})}
